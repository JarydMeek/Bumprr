name: Build and Push Docker Image

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      packages: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Bump version and create tag
      id: bump_version
      run: |
        # Get latest tag
        latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "Latest tag: $latest_tag"
        
        # Get commit message
        commit_msg=$(git log -1 --pretty=%B)
        echo "Commit message: $commit_msg"
        
        # Strip 'v' prefix
        version=${latest_tag#v}
        IFS='.' read -r major minor patch <<< "$version"
        
        # Determine bump type from commit message
        if echo "$commit_msg" | grep -qiE "^(breaking|breaking change|major):"; then
          # Major bump
          new_major=$((major + 1))
          new_version="v${new_major}.0.0"
        elif echo "$commit_msg" | grep -qiE "^(feat|feature):"; then
          # Minor bump
          new_minor=$((minor + 1))
          new_version="v${major}.${new_minor}.0"
        else
          # Patch bump (default)
          new_patch=$((patch + 1))
          new_version="v${major}.${minor}.${new_patch}"
        fi
        
        echo "New version: $new_version"
        echo "version=${new_version}" >> $GITHUB_OUTPUT
        echo "version_without_v=${new_version#v}" >> $GITHUB_OUTPUT
        
        # Create and push tag
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "$new_version" -m "Release $new_version"
        git push origin "$new_version"
    
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.bump_version.outputs.version }}
        release_name: Release ${{ steps.bump_version.outputs.version }}
        body: |
          Automated release ${{ steps.bump_version.outputs.version }}
          
          Commit: ${{ github.sha }}
        draft: false
        prerelease: false
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}
        tags: |
          type=ref,event=branch
          type=sha
          type=raw,value=${{ steps.bump_version.outputs.version_without_v }}
          type=raw,value=latest
    
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max